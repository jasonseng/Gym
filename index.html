import React, { useState, useEffect } from 'react';
import { 
  Dumbbell, 
  Calendar, 
  CheckCircle2, 
  Settings, 
  Trophy, 
  Activity, 
  ChevronRight, 
  ChevronDown,
  Play, 
  RotateCcw,
  Flame,
  User,
  Info,
  AlertCircle,
  Target,
  Zap,
  Cpu, 
  Footprints, 
  BicepsFlexed 
} from 'lucide-react';

// --- Constants & Defaults ---

const DEFAULT_EQUIPMENT = [
  { id: 'db', name: 'Dumbbells', icon: 'Weights', active: true },
  { id: 'bench', name: 'Adjustable Bench', icon: 'Archive', active: true },
  { id: 'bands', name: 'Resistance Bands', icon: 'Activity', active: true },
  { id: 'cable', name: 'Cable Machine / Pulley', icon: 'Cpu', active: true },
  { id: 'leg_machine', name: 'Leg Ext/Curl Machine', icon: 'Cpu', active: true },
  { id: 'smith', name: 'Smith Machine / Cage', icon: 'Cpu', active: false },
  { id: 'kettlebell', name: 'Kettlebell', icon: 'Dumbbell', active: false },
  { id: 'pullup', name: 'Pull-up Bar', icon: 'ArrowUp', active: false },
  { id: 'mat', name: 'Yoga Mat', icon: 'Layers', active: true },
  { id: 'cardio', name: 'Cardio Machine', icon: 'Bike', active: true },
];

const WEEK_SCHEDULE = {
  0: { id: 'sun', type: 'YOGA', title: 'Yoga & Mobility (Assisted)', icon: 'Activity', short: 'Sun' }, 
  1: { id: 'mon', type: 'GYM', title: 'Push Day (Chest/Triceps)', icon: 'Dumbbell', short: 'Mon' },
  2: { id: 'tue', type: 'GYM', title: 'Pull Day (Back/Biceps)', icon: 'Dumbbell', short: 'Tue' },
  3: { id: 'wed', type: 'GYM', title: 'Legs & Core', icon: 'Dumbbell', short: 'Wed' },
  4: { id: 'thu', type: 'GYM', title: 'Upper Body Focus', icon: 'Dumbbell', short: 'Thu' },
  5: { id: 'fri', type: 'GYM', title: 'Full Body HIIT', icon: 'Flame', short: 'Fri' },
  6: { id: 'sat', type: 'PT', title: 'PT Complementary (Accessory)', icon: 'User', short: 'Sat' }, 
};

// --- Full Weekly Fallback Data ---
const FALLBACK_WORKOUTS = {
  mon: [
    { 
      name: "Dumbbell Bench Press", sets: "4", reps: "10-12", focus: "Chest", 
      setup: "Lie flat on the bench. Plant your feet wide on the floor for stability. Squeeze your shoulder blades together underneath you (imagine holding a pencil between them).",
      execution: [
        "Start with arms extended above chest, palms facing forward.", 
        "Inhale deeply, then lower the weights slowly (3 seconds down) until the dumbbell handles are level with your chest.", 
        "Keep your elbows tucked at a 45-degree angle (think arrow shape, not a 'T' shape).", 
        "Exhale forcefully and drive the weights back up to the starting position without banging them together."
      ], 
      mistakes: "Flaring elbows out specifically to 90 degrees, which stresses the shoulders." 
    },
    { 
      name: "Cable Crossovers", sets: "3", reps: "12-15", focus: "Inner Chest", 
      setup: "Set pulleys to the highest position. Grab handles and step forward with one foot. Lean your torso slightly forward, keeping your back flat.",
      execution: [
        "Keep a soft bend in your elbows (like hugging a large tree).", 
        "Exhale and bring the handles down and across your body in a sweeping arc.", 
        "Squeeze your chest hard at the bottom where your hands meet.",
        "Inhale and slowly return to the start, feeling a deep stretch."
      ], 
      mistakes: "Turning the movement into a press by bending elbows too much." 
    },
    { 
      name: "Cable Tricep Pushdowns", sets: "3", reps: "15", focus: "Triceps", 
      setup: "Attach a rope to the high pulley. Stand facing the machine, feet shoulder-width. Grab the rope and pin your elbows tightly to your ribcage.",
      execution: [
        "Without moving your upper arms, exhale and extend your forearms downwards.", 
        "At the bottom, pull the rope ends apart for a stronger contraction.", 
        "Inhale and slowly let the weight come back up until your forearms are parallel to the floor.",
        "Keep your elbows glued to your sides the entire time."
      ], 
      mistakes: "Using momentum or letting elbows drift forward/upward." 
    }
  ],
  tue: [
    { 
      name: "Lat Pulldowns", sets: "4", reps: "10-12", focus: "Lats", 
      setup: "Adjust the knee pad so your legs are locked in tight. Grasp the bar slightly wider than shoulder width with an overhand grip.",
      execution: [
        "Retract your shoulder blades down first.",
        "Drive your elbows down towards the floor to pull the bar to your upper chest.", 
        "Think about pulling with your elbows, not your hands.",
        "Control the bar slowly on the way up, getting a full stretch at the top."
      ], 
      mistakes: "Leaning back too far to swing the weight down." 
    },
    { 
      name: "Single Arm Dumbbell Row", sets: "3", reps: "10/side", focus: "Lats", 
      setup: "Place your left knee and left hand on a bench. Your back should be flat like a table. Hold the dumbbell in your right hand, arm hanging straight down.",
      execution: [
        "Pull the dumbbell towards your back hip pocket (not your shoulder).", 
        "Keep your elbow close to your body.", 
        "Squeeze your back muscle at the top.", 
        "Lower the weight slowly to a full dead hang stretch."
      ], 
      mistakes: "Rotating your torso or jerking the weight up." 
    }
  ],
  wed: [
    { 
      name: "Leg Extensions", sets: "4", reps: "15-20", focus: "Quads", 
      setup: "Adjust the backrest so your knee aligns perfectly with the machine's pivot point. The bottom pad should rest on your lower shins/ankles.",
      execution: [
        "Grip the side handles firmly to keep your butt in the seat.", 
        "Exhale and extend your legs until they are straight.", 
        "Pause and squeeze your quads hard at the top for 1 second.", 
        "Lower the weight slowly under control."
      ], 
      mistakes: "Kicking the weight up explosively using momentum." 
    },
    { 
      name: "Goblet Squats", sets: "4", reps: "12", focus: "Quads/Glutes", 
      setup: "Hold one heavy dumbbell vertically against your chest, cupping the top end with both hands. Feet slightly wider than shoulders, toes pointed slightly out.",
      execution: [
        "Inhale and sit your hips back and down as if aiming for a low chair.", 
        "Keep your chest proud and elbows tucked inside your knees.", 
        "Go as deep as your flexibility allows (try to get thighs parallel to floor).", 
        "Exhale and drive through your heels to stand up."
      ], 
      mistakes: "Letting knees cave inward or heels lift off the floor." 
    }
  ],
  thu: [
    { 
      name: "Smith Machine Shoulder Press", sets: "4", reps: "10-12", focus: "Shoulders", 
      setup: "Place a bench under the Smith machine set to 90 degrees (or very high incline). Sit so the bar passes just in front of your face.",
      execution: [
        "Unrack the bar and lower it slowly to chin level.", 
        "Keep your elbows slightly forward, not flared completely to the sides.", 
        "Press the bar straight up to full extension.", 
        "Control the negative (downward phase) for 2-3 seconds."
      ], 
      mistakes: "Arching the lower back excessively to help push the weight." 
    },
    { 
      name: "Cable Lateral Raises", sets: "3", reps: "15", focus: "Side Delts", 
      setup: "Set the pulley to the lowest height. Stand sideways to the machine. Reach across your body to grab the handle with the far hand.",
      execution: [
        "Keep a slight bend in your elbow.", 
        "Raise your arm out to the side until it is parallel with the floor.", 
        "Think about pushing your hand 'out' towards the wall, not just 'up'.", 
        "Lower slowly back across your body."
      ], 
      mistakes: "Shrugging the traps (shoulders) up towards your ears." 
    }
  ],
  fri: [
    { 
      name: "Cable Woodchoppers", sets: "3", reps: "15/side", focus: "Obliques", 
      setup: "Set pulley to shoulder height. Stand side-on to the machine. Grip the handle with both hands, arms extended towards the pulley.",
      execution: [
        "Keep your arms relatively straight.", 
        "Pull the handle diagonally down across your body towards your opposite hip.", 
        "Pivot your back foot as you twist to protect your knee.", 
        "Control the return phase slowly to feel the core engage."
      ], 
      mistakes: "Bending the arms and pulling close to the chest instead of twisting." 
    },
    { 
      name: "Dumbbell Thrusters", sets: "4", reps: "12", focus: "Full Body", 
      setup: "Hold dumbbells at shoulder height, palms facing each other. Stand with feet shoulder-width apart.",
      execution: [
        "Perform a full squat, keeping chest up.", 
        "As you stand up explosively, use that momentum to press the weights straight overhead.", 
        "Lower the weights back to your shoulders smoothly as you descend into the next squat.", 
        "This should be one fluid, continuous motion."
      ], 
      mistakes: "Pausing in the middle. It should be one fluid movement from squat to press." 
    }
  ],
  sat: [
    {
      name: "Cable Face Pulls", sets: "3", reps: "15-20", focus: "Rear Delts/Posture",
      setup: "Set a rope attachment to eye level. Grasp the rope ends with thumbs facing YOU (or backwards).",
      execution: [
        "Pull the center of the rope right towards your nose.", 
        "As you pull, pull your hands apart and rotate your forearms upwards.", 
        "Squeeze your rear shoulders and upper back hard.", 
        "Return slowly."
      ],
      mistakes: "Pulling towards the chest or keeping hands close together."
    },
    {
      name: "Pallof Press", sets: "3", reps: "12/side", focus: "Core Stability",
      setup: "Stand sideways to a cable machine with a D-handle set to chest height. Hold the handle with both hands at the center of your chest.",
      execution: [
        "Step away to create tension on the cable.", 
        "Exhale and press your hands straight out in front of you.", 
        "Resist the cable trying to twist your body towards the machine.", 
        "Hold for 2 seconds, then slowly bring hands back to chest."
      ],
      mistakes: "Letting the torso twist or rotate. Stay rigid like a statue."
    },
    {
      name: "Dumbbell External Rotation", sets: "2", reps: "15/side", focus: "Rotator Cuff",
      setup: "Sit on the floor or a bench with one knee up. Rest your elbow on that knee. Hold a light dumbbell with forearm vertical.",
      execution: [
        "Slowly lower the dumbbell inward/downward.", 
        "Rotate your forearm back up to the vertical position.", 
        "Keep your elbow bent at 90 degrees and glued to your knee."
      ],
      mistakes: "Using momentum or too much weight. This is a small, delicate muscle."
    }
  ],
  sun: [
    {
      name: "Band Hamstring Stretch", sets: "2", reps: "60s/side", focus: "Flexibility",
      setup: "Lie on your back. Loop a resistance band around the sole of one foot. Hold the ends with your hands.",
      execution: [
        "Gently pull on the band to lift your leg towards the ceiling.", 
        "Keep your knee as straight as possible.", 
        "Relax your head and shoulders on the floor.", 
        "Breathe deeply and try to pull slightly further on every exhale."
      ],
      mistakes: "Bending the knee significantly reduces the stretch."
    },
    {
      name: "Weighted Goblet Squat Hold", sets: "2", reps: "30-60s hold", focus: "Hip Mobility",
      setup: "Hold a light dumbbell or kettlebell at your chest. Stand with feet wide.",
      execution: [
        "Sink down into the deepest squat you can manage.", 
        "Use your elbows to push your knees outward.", 
        "Keep your chest tall and spine straight (don't hunch).", 
        "Hold this bottom position and breathe into your hips."
      ],
      mistakes: "Rounding the back or letting heels lift."
    },
    {
      name: "Cable Torso Rotations (Light)", sets: "2", reps: "10/side", focus: "Spine Mobility",
      setup: "Set cable to chest height with very light weight. Stand sideways to machine.",
      execution: [
        "Grip handle with both hands.",
        "Slowly rotate your upper body away from the machine.", 
        "Focus on moving smoothly through your spine range of motion.", 
        "Do not force the movement; keep it gentle."
      ],
      mistakes: "Moving explosively. This is for mobility, not power."
    }
  ]
};

// --- Components ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden ${className}`}>
    {children}
  </div>
);

const Button = ({ onClick, children, variant = 'primary', className = "", disabled = false }) => {
  const baseStyle = "px-4 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
  const variants = {
    primary: "bg-emerald-500 hover:bg-emerald-600 text-zinc-900",
    secondary: "bg-zinc-800 hover:bg-zinc-700 text-zinc-100",
    outline: "border border-zinc-700 text-zinc-300 hover:border-zinc-500",
    ghost: "text-zinc-400 hover:text-white hover:bg-zinc-800/50"
  };
  return (
    <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
      {children}
    </button>
  );
};

const ExerciseCard = ({ ex }) => {
  const [expanded, setExpanded] = useState(false);
  const [completed, setCompleted] = useState(false);

  return (
    <Card className={`p-0 transition-all ${completed ? 'opacity-60' : 'opacity-100'}`}>
      <div className="p-5">
        <div className="flex justify-between items-start mb-2">
          <h3 className={`font-bold text-lg ${completed ? 'text-zinc-400 line-through' : 'text-white'}`}>
            {ex.name}
          </h3>
          <span className="bg-zinc-800 text-zinc-300 text-xs px-2 py-1 rounded font-mono">
            {ex.sets} x {ex.reps}
          </span>
        </div>
        
        <div className="flex gap-2 mb-3">
             {ex.focus && (
              <span className="flex items-center gap-1 text-xs text-emerald-400 bg-emerald-400/10 px-2 py-0.5 rounded">
                <Target size={10} /> {ex.focus}
              </span>
             )}
        </div>

        <button 
          onClick={() => setExpanded(!expanded)}
          className="w-full flex items-center justify-between text-sm text-zinc-400 bg-zinc-950/50 p-2 rounded hover:bg-zinc-950/80 transition-colors"
        >
          <span className="flex items-center gap-2"><Info size={14} /> Guide & Form</span>
          <ChevronDown size={14} className={`transition-transform duration-300 ${expanded ? 'rotate-180' : ''}`} />
        </button>

        <div className={`grid transition-all duration-300 ease-in-out ${expanded ? 'grid-rows-[1fr] opacity-100 mt-4' : 'grid-rows-[0fr] opacity-0'}`}>
           <div className="overflow-hidden space-y-4">
              
              {/* Setup Section */}
              {ex.setup && (
                <div className="border-l-2 border-blue-500/50 pl-3">
                    <h4 className="text-xs font-bold text-blue-400 uppercase mb-1 flex items-center gap-1">
                        <Footprints size={12} /> Setup
                    </h4>
                    <p className="text-sm text-zinc-300">{ex.setup}</p>
                </div>
              )}

              {/* Execution Section */}
              <div className="border-l-2 border-emerald-500/50 pl-3">
                <h4 className="text-xs font-bold text-emerald-400 uppercase mb-2 flex items-center gap-1">
                    <BicepsFlexed size={12} /> Execution
                </h4>
                <ol className="list-decimal pl-4 space-y-2 text-sm text-zinc-300">
                  {ex.execution && ex.execution.map((step, i) => (
                    <li key={i}>{step}</li>
                  ))}
                  {!ex.execution && ex.instructions && ex.instructions.map((step, i) => (
                    <li key={i}>{step}</li>
                  ))}
                </ol>
              </div>
              
              {/* Mistakes Section */}
              {ex.mistakes && (
                <div className="bg-red-500/10 border border-red-500/20 p-3 rounded-lg flex gap-2 items-start">
                  <AlertCircle size={14} className="text-red-400 shrink-0 mt-0.5" />
                  <p className="text-xs text-red-200"><span className="font-bold text-red-400">Avoid:</span> {ex.mistakes}</p>
                </div>
              )}
           </div>
        </div>

        <div className="mt-4 pt-4 border-t border-zinc-800 flex gap-2">
          <button 
            onClick={() => setCompleted(!completed)}
            className={`flex items-center gap-2 text-sm transition-colors ${completed ? 'text-emerald-500' : 'text-zinc-500 hover:text-emerald-500'}`}
          >
            {completed ? <CheckCircle2 size={20} className="fill-emerald-500/20" /> : <div className="w-5 h-5 rounded border border-zinc-600"></div>}
            {completed ? "Completed" : "Mark Set Complete"}
          </button>
        </div>
      </div>
    </Card>
  );
};

export default function App() {
  // State
  const [view, setView] = useState('dashboard'); 
  const [selectedDay, setSelectedDay] = useState(new Date().getDay()); 
  const [apiKey, setApiKey] = useState('');
  const [equipment, setEquipment] = useState(DEFAULT_EQUIPMENT);
  const [history, setHistory] = useState([]);
  const [generatedWorkout, setGeneratedWorkout] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Initial Load
  useEffect(() => {
    const savedKey = localStorage.getItem('gym_ai_key');
    const savedEquip = localStorage.getItem('gym_equipment');
    const savedHistory = localStorage.getItem('gym_history');
    
    if (savedKey) setApiKey(savedKey);
    if (savedEquip) setEquipment(JSON.parse(savedEquip));
    if (savedHistory) setHistory(JSON.parse(savedHistory));
  }, []);

  // Save Helpers
  const saveKey = (key) => {
    setApiKey(key);
    localStorage.setItem('gym_ai_key', key);
  };

  const saveEquipment = (newEquip) => {
    setEquipment(newEquip);
    localStorage.setItem('gym_equipment', JSON.stringify(newEquip));
  };

  const completeWorkout = (workoutData) => {
    const newEntry = {
      date: new Date().toISOString(),
      title: workoutData.title,
      dayId: WEEK_SCHEDULE[selectedDay].id,
      completed: true
    };
    const newHistory = [newEntry, ...history];
    setHistory(newHistory);
    localStorage.setItem('gym_history', JSON.stringify(newHistory));
    setView('dashboard');
  };

  // --- Logic ---
  const todayIndex = new Date().getDay();
  const scheduleSelected = WEEK_SCHEDULE[selectedDay];
  
  const today = new Date();
  const dateString = today.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  const completedToday = history.some(h => new Date(h.date).toDateString() === today.toDateString());

  const generateWorkout = async () => {
    setLoading(true);
    setError('');

    try {
      if (!apiKey) {
        // Fallback simulation
        await new Promise(r => setTimeout(r, 1000));
        const dayId = scheduleSelected.id;
        const fallbackList = FALLBACK_WORKOUTS[dayId];
        
        if (!fallbackList) {
             const generic = FALLBACK_WORKOUTS['mon'];
             setGeneratedWorkout({ title: scheduleSelected.title, exercises: generic, note: "Demo Mode" });
        } else {
             setGeneratedWorkout({
                title: scheduleSelected.title,
                exercises: fallbackList,
                note: "Demo Mode"
             });
        }
        
        setView('workout');
        setLoading(false);
        return;
      }

      // Real AI Call
      const availableEquip = equipment.filter(e => e.active).map(e => e.name).join(", ");
      
      let specialContext = "";
      if (scheduleSelected.id === 'sat') {
          specialContext = "This is a SATURDAY COMPLEMENTARY session (PT day). Use available GYM EQUIPMENT (Cables, Dumbbells, Bands) for accessory work, stability, and mobility. Avoid heavy max-effort compounds, but use equipment for isolation and active recovery.";
      } else if (scheduleSelected.id === 'sun') {
          specialContext = "This is a SUNDAY YOGA & RECOVERY session. Incorporate available GYM EQUIPMENT (Bands, Light Dumbbells, Cables) into the recovery routine where possible (e.g., weighted stretches, band distractions, light mobility work).";
      } else {
          specialContext = "Keep it FRESH: Vary the exercises, order, or tempo from standard generic routines.";
      }

      const prompt = `
        Act as a professional fitness trainer for a complete BEGINNER who needs help with form. Create a customized workout for: ${scheduleSelected.title}.
        
        Equipment available: ${availableEquip}.
        Goal: Hypertrophy and Strength.
        Duration: 45-60 minutes.

        PRIORITY INSTRUCTIONS:
        1. ${specialContext}
        2. If Machines (Cable/Leg/Smith) are available and appropriate, prioritize them.
        3. Provide EXTREMELY DETAILED, BEGINNER-FRIENDLY instructions. 
        4. Split instructions into 'Setup' (exact body positioning, grip, stance) and 'Execution' (movement path, breathing, tempo). 
        5. Assume the user is a beginner and needs cues on safety, breathing (e.g., "Inhale as you lower"), and tempo (e.g., "3 seconds down").

        Return STRICT JSON format only:
        {
          "title": "${scheduleSelected.title}",
          "warmup": "Brief warmup description",
          "exercises": [
            { 
              "name": "Exercise Name", 
              "sets": "3", 
              "reps": "12", 
              "setup": "Detailed description of how to position body and equipment before starting.",
              "execution": ["Step 1 of movement with breathing cue", "Step 2 of movement with tempo cue", "Step 3..."],
              "focus": "Main muscle worked",
              "mistakes": "Common form failure to avoid"
            }
          ],
          "cooldown": "Brief cooldown"
        }
      `;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      const data = await response.json();
      
      if (data.error) throw new Error(data.error.message);

      let text = data.candidates[0].content.parts[0].text;
      text = text.replace(/```json/g, '').replace(/```/g, '').trim();
      
      const workout = JSON.parse(text);
      setGeneratedWorkout(workout);
      setView('workout');

    } catch (err) {
      setError("Failed to generate workout. Please check your API Key.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // --- Views ---

  const Dashboard = () => (
    <div className="space-y-6 animate-in fade-in duration-500">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-white">Hello, Athlete</h1>
          <p className="text-zinc-400">{dateString}</p>
        </div>
        <button onClick={() => setView('settings')} className="p-2 bg-zinc-800 rounded-full hover:bg-zinc-700 text-zinc-300">
          <Settings size={20} />
        </button>
      </div>

      {/* Day Selector */}
      <div className="flex justify-between bg-zinc-900 p-1 rounded-xl border border-zinc-800">
        {[0, 1, 2, 3, 4, 5, 6].map((day) => {
           const isSelected = selectedDay === day;
           const isToday = todayIndex === day;
           return (
               <button
                 key={day}
                 onClick={() => setSelectedDay(day)}
                 className={`
                    relative flex-1 py-2 text-xs font-bold rounded-lg transition-all
                    ${isSelected ? 'bg-zinc-800 text-white shadow-sm' : 'text-zinc-500 hover:text-zinc-300'}
                 `}
               >
                 {WEEK_SCHEDULE[day].short}
                 {isToday && <div className="absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-emerald-500 rounded-full"></div>}
               </button>
           );
        })}
      </div>

      {/* Main Action Card */}
      <Card className="relative group">
        <div className="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-blue-500/10 opacity-50" />
        <div className="p-6 relative z-10">
          <div className="flex items-center gap-3 mb-4">
            <div className={`p-3 rounded-lg ${selectedDay === 6 ? 'bg-blue-500/20 text-blue-500' : selectedDay === 0 ? 'bg-purple-500/20 text-purple-500' : 'bg-emerald-500/20 text-emerald-500'}`}>
              {scheduleSelected.type === 'GYM' && <Dumbbell />}
              {scheduleSelected.type === 'PT' && <User />}
              {scheduleSelected.type === 'YOGA' && <Activity />}
            </div>
            <div>
              <h2 className="text-xl font-bold text-white">
                  {selectedDay === todayIndex ? "Today's Focus" : `${WEEK_SCHEDULE[selectedDay].short}'s Focus`}
              </h2>
              <p className="text-zinc-400 text-sm">{scheduleSelected.title}</p>
            </div>
          </div>

          <div className="space-y-4">
             <p className="text-zinc-300">
               {completedToday && selectedDay === todayIndex 
                 ? "You've already crushed a workout today, but you can always do another!" 
                 : scheduleSelected.type === 'PT' 
                    ? "Let's generate a mobility & primer session using your gear to complement your PT."
                    : scheduleSelected.type === 'YOGA' 
                    ? "Ready to flow? I'll build a gym-assisted recovery sequence."
                    : "Ready to train? I'll build a fresh, detailed plan for you."}
             </p>
             <Button onClick={generateWorkout} className="w-full" disabled={loading}>
               {loading ? (
                 <span className="flex items-center gap-2">
                   <span className="animate-spin rounded-full h-4 w-4 border-2 border-zinc-900 border-t-transparent"></span>
                   Designing Plan...
                 </span>
               ) : (
                 <span className="flex items-center gap-2"><Play size={18} fill="currentColor" /> Generate Workout</span>
               )}
             </Button>
             {error && <p className="text-red-400 text-sm text-center">{error}</p>}
          </div>
        </div>
      </Card>

      {/* Stats Row */}
      <div className="grid grid-cols-2 gap-4">
        <Card className="p-4 flex flex-col items-center justify-center bg-emerald-500/10 border-emerald-500/20">
          <Flame className="text-emerald-500 mb-2" size={24} />
          <span className="text-2xl font-bold text-emerald-500">{history.length}</span>
          <span className="text-xs text-zinc-500 uppercase tracking-wider">Total Workouts</span>
        </Card>
        <Card className="p-4 flex flex-col items-center justify-center">
          <Calendar className="text-blue-500 mb-2" size={24} />
          <span className="text-2xl font-bold text-white">{completedToday ? "Done" : "Pending"}</span>
          <span className="text-xs text-zinc-500 uppercase tracking-wider">Today Status</span>
        </Card>
      </div>

      {/* Quick Equipment Check */}
      <div className="bg-zinc-900 rounded-lg p-4 border border-zinc-800">
        <div className="flex justify-between items-center mb-3">
          <h3 className="text-zinc-400 text-sm uppercase font-bold tracking-wider">Active Equipment</h3>
          <button onClick={() => setView('settings')} className="text-xs text-emerald-500 hover:text-emerald-400">Edit</button>
        </div>
        <div className="flex flex-wrap gap-2">
          {equipment.filter(e => e.active).map(e => (
            <span key={e.id} className="text-xs bg-zinc-800 text-zinc-300 px-2 py-1 rounded border border-zinc-700">
              {e.name}
            </span>
          ))}
        </div>
      </div>
    </div>
  );

  const WorkoutSession = () => {
    if (!generatedWorkout) return null;

    return (
      <div className="space-y-6 pb-20 animate-in slide-in-from-bottom-10 duration-500">
        <div className="sticky top-0 bg-black/80 backdrop-blur-md py-4 z-20 border-b border-zinc-800 -mx-4 px-4">
            <div className="flex items-center gap-4">
                <button onClick={() => setView('dashboard')} className="p-1 hover:bg-zinc-800 rounded"><ChevronRight className="rotate-180" /></button>
                <div>
                    <h2 className="text-lg font-bold text-white">{generatedWorkout.title}</h2>
                    <p className="text-xs text-emerald-500">In Progress</p>
                </div>
            </div>
        </div>

        {generatedWorkout.warmup && (
             <Card className="p-4 bg-orange-500/10 border-orange-500/20">
                <h3 className="text-orange-400 font-bold text-sm uppercase mb-1">Warmup</h3>
                <p className="text-orange-100/80 text-sm">{generatedWorkout.warmup}</p>
             </Card>
        )}

        <div className="space-y-4">
            {generatedWorkout.exercises.map((ex, idx) => (
                <ExerciseCard key={idx} ex={ex} />
            ))}
        </div>

        <div className="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent">
            <Button onClick={() => completeWorkout(generatedWorkout)} className="w-full shadow-lg shadow-emerald-900/20">
                <CheckCircle2 /> Finish Workout
            </Button>
        </div>
      </div>
    );
  };

  const SettingsView = () => (
    <div className="space-y-6 animate-in fade-in duration-300">
      <div className="flex items-center gap-3 border-b border-zinc-800 pb-4">
        <button onClick={() => setView('dashboard')}><ChevronRight className="rotate-180" /></button>
        <h1 className="text-xl font-bold">Settings</h1>
      </div>

      <section>
        <h2 className="text-sm font-bold text-zinc-400 uppercase tracking-wider mb-4">AI Configuration</h2>
        <Card className="p-4">
            <label className="block text-sm text-zinc-300 mb-2">Gemini API Key</label>
            <input 
                type="password" 
                value={apiKey}
                onChange={(e) => saveKey(e.target.value)}
                placeholder="Paste API Key here..."
                className="w-full bg-zinc-950 border border-zinc-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-emerald-500 outline-none transition-all"
            />
            <p className="text-xs text-zinc-500 mt-2">
                Needed for custom daily generation. Your key is stored locally on your device.
            </p>
        </Card>
      </section>

      <section>
        <h2 className="text-sm font-bold text-zinc-400 uppercase tracking-wider mb-4">My Home Equipment</h2>
        <div className="space-y-2">
            {equipment.map((item) => (
                <button
                    key={item.id}
                    onClick={() => {
                        const newEquip = equipment.map(e => e.id === item.id ? {...e, active: !e.active} : e);
                        saveEquipment(newEquip);
                    }}
                    className={`w-full flex items-center justify-between p-4 rounded-lg border transition-all ${
                        item.active 
                        ? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-100' 
                        : 'bg-zinc-900 border-zinc-800 text-zinc-500'
                    }`}
                >
                    <span className="font-medium">{item.name}</span>
                    {item.active && <CheckCircle2 size={18} className="text-emerald-500" />}
                </button>
            ))}
        </div>
      </section>

      <div className="pt-8">
        <h2 className="text-sm font-bold text-zinc-400 uppercase tracking-wider mb-4">History Log</h2>
        {history.length === 0 ? (
            <p className="text-zinc-600 text-center py-4">No completed workouts yet.</p>
        ) : (
            <div className="space-y-2">
                {history.slice(0, 5).map((h, i) => (
                    <div key={i} className="flex justify-between items-center p-3 bg-zinc-900 border border-zinc-800 rounded-lg">
                        <span className="text-zinc-300">{h.title}</span>
                        <span className="text-xs text-zinc-500">{new Date(h.date).toLocaleDateString()}</span>
                    </div>
                ))}
            </div>
        )}
      </div>
      
      <div className="h-10"></div>
    </div>
  );

  return (
    <div className="min-h-screen bg-black text-zinc-100 font-sans selection:bg-emerald-500/30">
      <div className="max-w-md mx-auto min-h-screen p-6 relative">
        {view === 'dashboard' && <Dashboard />}
        {view === 'workout' && <WorkoutSession />}
        {view === 'settings' && <SettingsView />}
      </div>
    </div>
  );
}
